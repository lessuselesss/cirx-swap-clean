name: Deploy to FTP Server

# ====================================
# TRIGGER CONFIGURATION
# ====================================
on:
  # Trigger on push to main branch
  push:
    branches:
      - main
      # - master            # Uncomment if your default branch is 'master'
      # - production        # Uncomment for production branch
      # - staging          # Uncomment for staging branch
  
  # Manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      
      dry_run:
        description: 'Perform a dry run (no actual upload)'
        required: false
        default: false
        type: boolean

  # Uncomment to run on pull request (for testing)
  # pull_request:
  #   branches:
  #     - main

  # Uncomment to run on schedule (cron)
  # schedule:
  #   - cron: '0 2 * * *'  # Daily at 2 AM UTC

# ====================================
# ENVIRONMENT VARIABLES
# ====================================
env:
  # PHP version for backend build
  PHP_VERSION: '8.2'
  
  # Node version for frontend build
  NODE_VERSION: '20'
  
  # Deployment paths
  BACKEND_LOCAL_DIR: './backend'
  FRONTEND_LOCAL_DIR: './ui'
  
  # FTP remote directories (production paths)
  BACKEND_REMOTE_DIR: '/api'
  FRONTEND_REMOTE_DIR: '/'
  
  # Build output directory for frontend
  FRONTEND_BUILD_DIR: './ui/.output/public'
  
  # Uncomment to enable debug logging
  # DEBUG: true

# ====================================
# JOBS
# ====================================
jobs:
  # ====================================
  # SINGLE JOB: Build and Deploy Everything
  # ====================================
  build-and-deploy:
    name: Build and Deploy to FTP Server
    runs-on: ubuntu-latest
    
    # Environment protection rules (optional)
    # environment:
    #   name: production
    #   url: ${{ secrets.SITE_URL }}
    
    steps:
      # Step 1: Checkout code
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Step 2: Setup PHP for backend
      - name: ðŸ˜ Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, pdo, sqlite, pdo_sqlite, bcmath, json
          tools: composer:v2
      
      # Step 3: Setup Node.js for frontend
      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_LOCAL_DIR }}/package-lock.json
      
      # Step 4: Create .env file from secrets and environment variables (BEFORE any builds)
      - name: ðŸ” Create backend .env file
        working-directory: ${{ env.BACKEND_LOCAL_DIR }}
        env:
          # Secrets
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          CIRX_WALLET_ADDRESS: ${{ secrets.CIRX_WALLET_ADDRESS }}
          CIRX_WALLET_PRIVATE_KEY: ${{ secrets.CIRX_WALLET_PRIVATE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          ETHEREUM_RPC_URL: ${{ secrets.ETHEREUM_RPC_URL }}
          ETHEREUM_RPC_URL_BACKUP: ${{ secrets.ETHEREUM_RPC_URL_BACKUP }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          INFURA_PROJECT_ID: ${{ secrets.INFURA_PROJECT_ID }}
          PLATFORM_FEE_WALLET: ${{ secrets.PLATFORM_FEE_WALLET }}
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          SEPOLIA_RPC_URL_BACKUP: ${{ secrets.SEPOLIA_RPC_URL_BACKUP }}
          CIRX_BALANCE_ALERT_THRESHOLD: ${{ secrets.CIRX_BALANCE_ALERT_THRESHOLD }}
          CORS_ALLOW_CREDENTIALS: ${{ secrets.CORS_ALLOW_CREDENTIALS }}
          CORS_MAX_AGE: ${{ secrets.CORS_MAX_AGE }}
          # Variables
          ADMIN_TOKEN_REQUIRED: ${{ vars.ADMIN_TOKEN_REQUIRED }}
          API_LOGGING_ENABLED: ${{ vars.API_LOGGING_ENABLED }}
          APP_DEBUG: ${{ vars.APP_DEBUG }}
          APP_ENV: ${{ vars.APP_ENV }}
          APP_TIMEZONE: ${{ vars.APP_TIMEZONE }}
          APP_URL: ${{ vars.APP_URL }}
          CIRX_NAG_URL: ${{ vars.CIRX_NAG_URL }}
          CIRX_NAG_URL_BACKUP: ${{ vars.CIRX_NAG_URL_BACKUP }}
          CORS_ALLOWED_ORIGINS: ${{ vars.CORS_ALLOWED_ORIGINS }}
          ETHEREUM_CHAIN_ID: ${{ vars.ETHEREUM_CHAIN_ID }}
          ETHEREUM_NETWORK: ${{ vars.ETHEREUM_NETWORK }}
          IROH_BRIDGE_URL: ${{ vars.IROH_BRIDGE_URL }}
          LOG_CHANNEL: ${{ vars.LOG_CHANNEL }}
          LOG_FILE_PATH: ${{ vars.LOG_FILE_PATH }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
          LOG_MAX_FILES: ${{ vars.LOG_MAX_FILES }}
          LOG_REQUEST_BODY: ${{ vars.LOG_REQUEST_BODY }}
          LOG_RESPONSE_BODY: ${{ vars.LOG_RESPONSE_BODY }}
          WORKER_BATCH_SIZE: ${{ vars.WORKER_BATCH_SIZE }}
          WORKER_PROCESS_INTERVAL: ${{ vars.WORKER_PROCESS_INTERVAL }}
          SEPOLIA_CHAIN_ID: ${{ vars.SEPOLIA_CHAIN_ID }}
        run: |
          cat > .env << EOF
          # Application Settings
          APP_NAME=CIRX_OTC
          APP_ENV=${APP_ENV}
          APP_DEBUG=${APP_DEBUG}
          APP_URL=${APP_URL}
          APP_TIMEZONE=${APP_TIMEZONE}
          
          # Admin Security Configuration  
          ADMIN_TOKEN_REQUIRED=${ADMIN_TOKEN_REQUIRED}
          ADMIN_TOKEN=${ADMIN_TOKEN}
          
          # Database Configuration - Use SQLite for production
          DB_CONNECTION=sqlite
          DB_DATABASE=./storage/database.sqlite
          
          # Blockchain Configuration
          ETHEREUM_RPC_URL=${ETHEREUM_RPC_URL}
          ETHEREUM_RPC_URL_BACKUP=${ETHEREUM_RPC_URL_BACKUP}
          ETHEREUM_CHAIN_ID=${ETHEREUM_CHAIN_ID}
          ETHEREUM_NETWORK=${ETHEREUM_NETWORK}
          ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY}
          
          # Sepolia Testnet Configuration
          SEPOLIA_RPC_URL=${SEPOLIA_RPC_URL}
          SEPOLIA_RPC_URL_BACKUP=${SEPOLIA_RPC_URL_BACKUP}
          SEPOLIA_CHAIN_ID=${SEPOLIA_CHAIN_ID}
          
          # CIRX Blockchain Configuration
          CIRX_NAG_URL=${CIRX_NAG_URL}
          CIRX_NAG_URL_BACKUP=${CIRX_NAG_URL_BACKUP}
          CIRX_WALLET_PRIVATE_KEY=${CIRX_WALLET_PRIVATE_KEY}
          CIRX_WALLET_ADDRESS=${CIRX_WALLET_ADDRESS}
          CIRX_DECIMALS=18
          
          # Testing Configuration
          TESTNET_MODE=true
          
          # CORS Configuration
          CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
          CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS}
          CORS_MAX_AGE=${CORS_MAX_AGE}
          
          # Worker Configuration
          WORKER_BATCH_SIZE=${WORKER_BATCH_SIZE}
          WORKER_PROCESS_INTERVAL=${WORKER_PROCESS_INTERVAL}
          
          # Logging Configuration
          LOG_LEVEL=${LOG_LEVEL}
          LOG_CHANNEL=${LOG_CHANNEL}
          LOG_FILE_PATH=${LOG_FILE_PATH}
          LOG_MAX_FILES=${LOG_MAX_FILES}
          API_LOGGING_ENABLED=${API_LOGGING_ENABLED}
          LOG_REQUEST_BODY=${LOG_REQUEST_BODY}
          LOG_RESPONSE_BODY=${LOG_RESPONSE_BODY}
          
          # Platform Configuration
          PLATFORM_FEE_WALLET=${PLATFORM_FEE_WALLET}
          
          # Feature Flags
          FEATURE_BATCH_TRANSFERS=false
          FEATURE_AUTOMATIC_RETRIES=true
          FEATURE_SLACK_NOTIFICATIONS=false
          FEATURE_ADVANCED_MONITORING=false
          
          # Telegram Bot Configuration
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          CIRX_BALANCE_ALERT_THRESHOLD=${CIRX_BALANCE_ALERT_THRESHOLD}
          
          # IROH Distributed Networking Configuration
          IROH_ENABLED=false
          IROH_BRIDGE_URL=${IROH_BRIDGE_URL}
          EOF
      
      # Step 5: Build backend
      - name: ðŸ”¨ Build Backend
        working-directory: ${{ env.BACKEND_LOCAL_DIR }}
        run: |
          composer install --no-dev --optimize-autoloader
          # Create storage directory and SQLite database
          mkdir -p storage
          touch storage/database.sqlite
          chmod 664 storage/database.sqlite
          # Set production permissions
          find . -type f -name "*.php" -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          echo "âœ… Backend built successfully"
      
      # Step 6: Build frontend
      - name: ðŸ”¨ Build Frontend
        working-directory: ${{ env.FRONTEND_LOCAL_DIR }}
        env:
          NUXT_PUBLIC_REOWN_PROJECT_ID: ${{ secrets.NUXT_PUBLIC_REOWN_PROJECT_ID }}
          NUXT_PUBLIC_TESTNET_MODE: true
          NUXT_PUBLIC_API_BASE_URL: ${{ secrets.NUXT_PUBLIC_API_BASE_URL || 'https://circularprotocol.io/buy/api/v1' }}
        run: |
          npm ci --prefer-offline --no-audit
          npm run build
          echo "âœ… Frontend built successfully"
      
      # Deploy Backend via FTP
      - name: ðŸš€ Deploy Backend to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          # FTP server credentials (REQUIRED - set in GitHub Secrets)
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          
          # FTP server port (default: 21)
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Protocol to use
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}  # Options: ftp, ftps, ftps-legacy
          
          # Local directory to upload from
          local-dir: ./backend/
          
          # Remote directory to upload to
          server-dir: ${{ env.BACKEND_REMOTE_DIR }}/
          
          # Dry run mode (test without uploading)
          dry-run: ${{ github.event.inputs.dry_run || false }}
          
          # Security options
          # dangerous-clean-slate: false  # WARNING: Deletes ALL files on server before upload
          
          # Exclude files/folders from upload
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env.example
            **/tests/**
            **/test/**
            **/*.test.js
            **/*.test.ts
            **/README.md
            **/CLAUDE.md
            **/.vscode/**
            **/.idea/**
            **/composer.lock
            **/package-lock.json
          
          # Include only specific files (uncomment to use)
          # include: |
          #   **/*.php
          #   **/*.js
          #   **/*.css
          #   **/*.html
          
          # Logging level (options: minimal, standard, verbose)
          log-level: standard
          
          # Timeout settings (in milliseconds)
          timeout: 120000  # 2 minutes
      
      # Deploy Frontend via FTP
      - name: ðŸš€ Deploy Frontend to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}
          local-dir: ./ui/.output/public/
          server-dir: ${{ env.FRONTEND_REMOTE_DIR }}/
          dry-run: ${{ github.event.inputs.dry_run || false }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env*
            **/README.md
          log-level: standard
          timeout: 120000
      
      # Send notification on success (optional)
      - name: ðŸ“¨ Send success notification
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          # Add Slack, Discord, or email notification here
          
          # Example: Send to Telegram
          # curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          #   -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          #   -d "text=âœ… Deployment successful to FTP server!"
      
      # Send notification on failure (optional)
      - name: ðŸ“¨ Send failure notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          # Add notification here


# ====================================
# ADVANCED CONFIGURATION OPTIONS
# ====================================

# Concurrency control (prevent multiple deployments)
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false  # Set to true to cancel in-progress deployments

# Job timeout
# defaults:
#   run:
#     timeout-minutes: 30

# Matrix strategy for multiple environments
# strategy:
#   matrix:
#     environment: [staging, production]
#     include:
#       - environment: staging
#         ftp_server: ${{ secrets.STAGING_FTP_SERVER }}
#         remote_dir: /staging
#       - environment: production
#         ftp_server: ${{ secrets.PRODUCTION_FTP_SERVER }}
#         remote_dir: /public_html

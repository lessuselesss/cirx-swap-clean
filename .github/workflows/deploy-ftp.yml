name: Deploy to FTP Server

# ====================================
# TRIGGER CONFIGURATION
# ====================================
on:
  # Trigger on push to main branch
  push:
    branches:
      - main
      # - master            # Uncomment if your default branch is 'master'
      # - production        # Uncomment for production branch
      # - staging          # Uncomment for staging branch
  
  # Manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      
      dry_run:
        description: 'Perform a dry run (no actual upload)'
        required: false
        default: false
        type: boolean

  # Uncomment to run on pull request (for testing)
  # pull_request:
  #   branches:
  #     - main

  # Uncomment to run on schedule (cron)
  # schedule:
  #   - cron: '0 2 * * *'  # Daily at 2 AM UTC

# ====================================
# ENVIRONMENT VARIABLES
# ====================================
env:
  # PHP version for backend build
  PHP_VERSION: '8.2'
  
  # Node version for frontend build
  NODE_VERSION: '20'
  
  # Deployment paths
  BACKEND_LOCAL_DIR: './backend'
  FRONTEND_LOCAL_DIR: './ui'
  
  # FTP remote directories (production paths)
  BACKEND_REMOTE_DIR: '/api'
  FRONTEND_REMOTE_DIR: '/'
  
  # Build output directory for frontend
  FRONTEND_BUILD_DIR: './ui/.output/public'
  
  # Uncomment to enable debug logging
  # DEBUG: true

# ====================================
# JOBS
# ====================================
jobs:
  # ====================================
  # SINGLE JOB: Build and Deploy Everything
  # ====================================
  build-and-deploy:
    name: Build and Deploy to FTP Server
    runs-on: ubuntu-latest
    
    # Environment protection rules (optional)
    # environment:
    #   name: production
    #   url: ${{ secrets.SITE_URL }}
    
    steps:
      # Step 1: Checkout code
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
      
      # Step 2: Setup PHP for backend
      - name: 🐘 Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, pdo, sqlite, pdo_sqlite, bcmath, json
          tools: composer:v2
      
      # Step 3: Setup Node.js for frontend
      - name: 🟢 Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_LOCAL_DIR }}/package-lock.json
      
      # Step 4: Create .env file from secrets (BEFORE any builds)
      - name: 🔐 Create backend .env file
        working-directory: ${{ env.BACKEND_LOCAL_DIR }}
        run: |
          cat > .env << EOF
          # Application Settings
          APP_NAME="${{ secrets.APP_NAME || 'CIRX_OTC' }}"
          APP_ENV="${{ secrets.APP_ENV || 'production' }}"
          APP_DEBUG="${{ secrets.APP_DEBUG || 'false' }}"
          APP_URL="${{ secrets.APP_URL || 'https://circularprotocol.io/buy' }}"
          
          # Database Configuration - Use SQLite by default (same as development)
          DB_CONNECTION="${{ secrets.DB_CONNECTION || 'sqlite' }}"
          DB_DATABASE="${{ secrets.DB_DATABASE || './storage/database.sqlite' }}"
          # MySQL options (only used if DB_CONNECTION is set to mysql in secrets)
          DB_HOST="${{ secrets.DB_HOST }}"
          DB_PORT="${{ secrets.DB_PORT || '3306' }}"
          DB_USERNAME="${{ secrets.DB_USERNAME }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          
          # API Keys
          API_KEY="${{ secrets.API_KEY }}"
          CIRCULAR_API_KEY="${{ secrets.CIRCULAR_API_KEY }}"
          CIRCULAR_API_URL="${{ secrets.CIRCULAR_API_URL }}"
          
          # Network Configuration
          TESTNET_MODE="${{ secrets.TESTNET_MODE || 'true' }}"
          
          # Additional Secrets
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          EOF
      
      # Step 5: Build backend
      - name: 🔨 Build Backend
        working-directory: ${{ env.BACKEND_LOCAL_DIR }}
        run: |
          composer install --no-dev --optimize-autoloader
          # Create storage directory and SQLite database
          mkdir -p storage
          touch storage/database.sqlite
          chmod 664 storage/database.sqlite
          # Set production permissions
          find . -type f -name "*.php" -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          echo "✅ Backend built successfully"
      
      # Step 6: Build frontend
      - name: 🔨 Build Frontend
        working-directory: ${{ env.FRONTEND_LOCAL_DIR }}
        env:
          NUXT_PUBLIC_REOWN_PROJECT_ID: ${{ secrets.NUXT_PUBLIC_REOWN_PROJECT_ID }}
          NUXT_PUBLIC_TESTNET_MODE: true
          NUXT_PUBLIC_API_BASE_URL: ${{ secrets.NUXT_PUBLIC_API_BASE_URL || 'https://circularprotocol.io/buy/api/v1' }}
        run: |
          npm ci --prefer-offline --no-audit
          npm run build
          echo "✅ Frontend built successfully"
      
      # Deploy Backend via FTP
      - name: 🚀 Deploy Backend to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          # FTP server credentials (REQUIRED - set in GitHub Secrets)
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          
          # FTP server port (default: 21)
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Protocol to use
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}  # Options: ftp, ftps, ftps-legacy
          
          # Local directory to upload from
          local-dir: ./backend/
          
          # Remote directory to upload to
          server-dir: ${{ env.BACKEND_REMOTE_DIR }}/
          
          # Dry run mode (test without uploading)
          dry-run: ${{ github.event.inputs.dry_run || false }}
          
          # Security options
          # dangerous-clean-slate: false  # WARNING: Deletes ALL files on server before upload
          
          # Exclude files/folders from upload
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env.example
            **/tests/**
            **/test/**
            **/*.test.js
            **/*.test.ts
            **/README.md
            **/CLAUDE.md
            **/.vscode/**
            **/.idea/**
            **/composer.lock
            **/package-lock.json
          
          # Include only specific files (uncomment to use)
          # include: |
          #   **/*.php
          #   **/*.js
          #   **/*.css
          #   **/*.html
          
          # Logging level (options: minimal, standard, verbose)
          log-level: standard
          
          # Timeout settings (in milliseconds)
          timeout: 120000  # 2 minutes
      
      # Deploy Frontend via FTP
      - name: 🚀 Deploy Frontend to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftp' }}
          local-dir: ./ui/.output/public/
          server-dir: ${{ env.FRONTEND_REMOTE_DIR }}/
          dry-run: ${{ github.event.inputs.dry_run || false }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env*
            **/README.md
          log-level: standard
          timeout: 120000
      
      # Send notification on success (optional)
      - name: 📨 Send success notification
        if: success()
        run: |
          echo "✅ Deployment successful!"
          # Add Slack, Discord, or email notification here
          
          # Example: Send to Telegram
          # curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          #   -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          #   -d "text=✅ Deployment successful to FTP server!"
      
      # Send notification on failure (optional)
      - name: 📨 Send failure notification
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          # Add notification here


# ====================================
# ADVANCED CONFIGURATION OPTIONS
# ====================================

# Concurrency control (prevent multiple deployments)
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false  # Set to true to cancel in-progress deployments

# Job timeout
# defaults:
#   run:
#     timeout-minutes: 30

# Matrix strategy for multiple environments
# strategy:
#   matrix:
#     environment: [staging, production]
#     include:
#       - environment: staging
#         ftp_server: ${{ secrets.STAGING_FTP_SERVER }}
#         remote_dir: /staging
#       - environment: production
#         ftp_server: ${{ secrets.PRODUCTION_FTP_SERVER }}
#         remote_dir: /public_html
